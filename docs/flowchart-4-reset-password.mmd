---
title: 4. Alur Reset Password dengan Persetujuan Admin
---
flowchart TD
    Start([User Lupa Password]) --> LoginPage[User di Halaman Login]
    LoginPage --> ClickForgot[Klik: Lupa Password?]
    
    %% FASE 1: USER REQUEST RESET
    ClickForgot --> ForgotForm[Form Forgot Password]
    ForgotForm --> InputEmail[User Input Email]
    InputEmail --> SubmitRequest[Submit Request]
    
    SubmitRequest --> ValidateEmail{Email Valid?}
    ValidateEmail -->|Email Tidak Terdaftar| ErrEmail[Error: Email Tidak Ditemukan]
    ErrEmail --> ForgotForm
    
    ValidateEmail -->|Valid| CheckExisting{Sudah Ada<br/>Request Pending?}
    CheckExisting -->|Ya| ErrPending[Error: Sudah Ada Request Pending<br/>Tunggu Review Admin]
    ErrPending --> ForgotForm
    
    CheckExisting -->|Tidak| CreateRequest[System Create Request:<br/>- email<br/>- status: pending<br/>- created_at]
    CreateRequest --> SuccessMsg[Success Message:<br/>Permintaan reset password<br/>telah dikirim ke admin]
    SuccessMsg --> WaitAdmin[User Menunggu Persetujuan Admin]
    
    %% FASE 2: ADMIN REVIEW REQUEST
    WaitAdmin -.-> AdminLoginPW[Admin Login]
    AdminLoginPW --> AdminPWMenu[Admin: Menu Password Reset Management]
    AdminPWMenu --> AdminPWList[List Semua Request:<br/>- Pending<br/>- Approved<br/>- Rejected]
    
    AdminPWList --> FilterStatus[Admin Filter by Status]
    FilterStatus --> AdminPWDetail[Admin: View Detail Request:<br/>- Email<br/>- Tanggal Request<br/>- Status]
    
    AdminPWDetail --> AdminDecision{Admin Decision}
    
    %% REJECT PATH
    AdminDecision -->|REJECT| InputRejectReason[Admin Input:<br/>Alasan Penolakan]
    InputRejectReason --> ConfirmReject{Konfirmasi<br/>Reject?}
    ConfirmReject -->|Tidak| AdminPWDetail
    
    ConfirmReject -->|Ya| SaveReject[Update Request:<br/>- status: rejected<br/>- rejection_reason<br/>- reviewed_at<br/>- reviewed_by]
    SaveReject --> NotifReject[User: Request Ditolak<br/>Lihat Alasan di Website]
    
    NotifReject --> UserCheckReject[User Login & Cek Status]
    UserCheckReject --> ShowReject[Tampil: Request Ditolak<br/>Alasan: ...]
    ShowReject --> UserChoiceReject{User Action}
    
    UserChoiceReject -->|Request Ulang| ForgotForm
    UserChoiceReject -->|Hubungi Admin| ContactAdmin[Hubungi Admin via Phone]
    
    %% APPROVE PATH
    AdminDecision -->|APPROVE| ConfirmApprove{Konfirmasi<br/>Approve?}
    ConfirmApprove -->|Tidak| AdminPWDetail
    
    ConfirmApprove -->|Ya| GenerateToken[System Generate:<br/>- Reset Token unique<br/>- Expired: 60 menit]
    GenerateToken --> SaveApprove[Update Request:<br/>- status: approved<br/>- token<br/>- token_expires_at<br/>- reviewed_at<br/>- reviewed_by]
    SaveApprove --> CreateResetLink[Generate Reset Link:<br/>/password/reset/token]
    
    CreateResetLink --> NotifApprove[Notifikasi User:<br/>Reset Password Disetujui<br/>in real app: Send Email]
    
    %% FASE 3: USER RESET PASSWORD
    NotifApprove --> UserCheckApprove[User Login & Cek Status]
    UserCheckApprove --> ShowLink[Tampil: Link Reset Password<br/>atau Kirim via Email]
    ShowLink --> UserClickLink[User Klik Link Reset]
    
    UserClickLink --> ValidateToken{Token Valid?}
    ValidateToken -->|Token Tidak Ada| ErrTokenInvalid[Error: Token Tidak Valid]
    ErrTokenInvalid --> LoginPage
    
    ValidateToken -->|Token Expired| ErrTokenExpired[Error: Token Kadaluarsa<br/>60 menit]
    ErrTokenExpired --> RequestAgain[Silakan Request Ulang]
    RequestAgain --> ForgotForm
    
    ValidateToken -->|Valid| ShowResetForm[Tampil Form Reset Password]
    ShowResetForm --> InputNewPassword[User Input:<br/>- Email readonly<br/>- Password Baru<br/>- Konfirmasi Password]
    InputNewPassword --> SubmitReset[Submit Reset Password]
    
    SubmitReset --> ValidatePassword{Validasi}
    ValidatePassword -->|Password Tidak Match| ErrMatch[Error: Password Tidak Cocok]
    ErrMatch --> ShowResetForm
    
    ValidatePassword -->|Password Kurang 8 Karakter| ErrLength[Error: Min 8 Karakter]
    ErrLength --> ShowResetForm
    
    ValidatePassword -->|Valid| UpdatePassword[Update User Password:<br/>Bcrypt Hash]
    UpdatePassword --> DeleteToken[Hapus/Mark Used Token]
    DeleteToken --> SuccessReset[Success: Password Berhasil Diubah]
    
    SuccessReset --> RedirectLogin[Redirect ke Login]
    RedirectLogin --> UserLoginNew[User Login dengan Password Baru]
    UserLoginNew --> Dashboard[Login Sukses → Dashboard]
    
    Dashboard --> End([PROSES SELESAI ✅])
    
    %% ADMIN DELETE REQUEST (Optional)
    AdminPWList -.->|Super Admin Only| AdminDelete[Admin: Delete Request]
    AdminDelete --> ConfirmDelete{Konfirmasi Delete?}
    ConfirmDelete -->|Ya| HardDelete[Hard Delete Request<br/>dari Database]
    HardDelete --> AdminPWList
    
    style Start fill:#28a745,stroke:#1e7e34,stroke-width:3px,color:#fff
    style End fill:#28a745,stroke:#1e7e34,stroke-width:3px,color:#fff
    style ErrEmail fill:#dc3545,stroke:#bd2130,stroke-width:3px,color:#fff
    style ErrPending fill:#dc3545,stroke:#bd2130,stroke-width:3px,color:#fff
    style ErrTokenInvalid fill:#dc3545,stroke:#bd2130,stroke-width:3px,color:#fff
    style ErrTokenExpired fill:#dc3545,stroke:#bd2130,stroke-width:3px,color:#fff
    style ErrMatch fill:#dc3545,stroke:#bd2130,stroke-width:3px,color:#fff
    style ErrLength fill:#dc3545,stroke:#bd2130,stroke-width:3px,color:#fff
    style SaveApprove fill:#28a745,stroke:#1e7e34,stroke-width:2px,color:#fff
    style SuccessReset fill:#28a745,stroke:#1e7e34,stroke-width:2px,color:#fff
    style Dashboard fill:#007bff,stroke:#0056b3,stroke-width:3px,color:#fff
